#!/usr/bin/env expect

set timeout 300

set cpipe [lindex $argv 0];
set cpipe_msg [lindex $argv 1];
set arguments [lrange $argv 2 end]
spawn bazel run //:fido2_conformance -- --token_path=_ {*}$arguments
set baz_id $spawn_id

while 1 {
    expect "Please replug the device, then hit enter."
    spawn bash -c "echo '$cpipe_msg' > $cpipe"
    sleep 10
    set spawn_id $baz_id
    send "\r"
}